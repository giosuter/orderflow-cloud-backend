#!/usr/bin/env bash
set -euo pipefail

# Block committing changes to already-applied Flyway migrations (V1..V5)
FROZEN_REGEX='^src/main/resources/db/migration/V(1|2|3|4|5)__.*\.sql$'

# List staged files
STAGED_FILES=$(git diff --cached --name-only)

# Find forbidden staged files
BLOCKED_FILES=$(echo "$STAGED_FILES" | grep -E "$FROZEN_REGEX" || true)

if [[ -n "$BLOCKED_FILES" ]]; then
  echo
  echo "ERROR: You are trying to commit changes to frozen Flyway migrations (V1..V5)."
  echo "These migrations are already applied to production and must NEVER be changed."
  echo
  echo "Blocked files:"
  echo "$BLOCKED_FILES"
  echo
  echo "What to do instead:"
  echo "  - revert the changes to these files"
  echo "  - create a NEW migration (V6__, V7__, ...)"
  echo
  exit 1
fi

exit 0
